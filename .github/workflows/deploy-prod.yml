name: Deploy Production (Master)

on:
  push:
    branches:
      - master
  workflow_dispatch:

concurrency:
  group: deploy-app-prod
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Preparar chave SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.VPS_PORT }} -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy via SSH
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 120
          command: |
            ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no \
              -i ~/.ssh/deploy_key \
              -p ${{ secrets.VPS_PORT }} \
              ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
              'set -euo pipefail

              APP_DIR="/var/www/fiestou-app"

              echo ">> Go to app dir"
              cd "$APP_DIR"

              echo ">> Updating code"
              git fetch --all --prune
              git checkout master
              git reset --hard origin/master

              echo ">> Installing dependencies"
              npm ci

              echo ">> Building app"
              npm run build

              echo ">> Restarting PM2"
              pm2 restart fiestou-app || pm2 start npm --name "fiestou-app" -- start -- -p 3000

              echo ">> Deploy producao finalizado"'
